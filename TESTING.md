# Инструкции по тестированию бота

## Что было исправлено

### 1. Порядок обработчиков (главная проблема!)
Обработчик `content_types=types.ContentType.ANY` был зарегистрирован **до** обработчиков команд и перехватывал все сообщения, включая команды. В aiogram порядок регистрации обработчиков критически важен - первый подходящий обработчик захватывает сообщение.

**Исправлено:** Обработчик `content_types=types.ContentType.ANY` перемещён в конец файла.

### 2. Доступ к объектам aiogram
Код обращался к объектам aiogram как к словарям (`member['status']`), но они являются объектами с атрибутами.

**Исправлено:** Везде заменено на `member.status` с проверкой `hasattr()`.

### 3. Извлечение аргументов команд
Использовались несуществующие методы `message.get_args()` и `message.get_command()`.

**Исправлено:** Аргументы извлекаются напрямую из `message.text` с помощью `.split()`.

### 4. Добавлено логирование
Уровень логирования изменён с `WARNING` на `INFO`, добавлены логи для отладки команд.

## Как протестировать

### 1. Убедитесь, что бот может читать сообщения в группах
В BotFather выполните:
```
/mybots -> [Ваш бот] -> Bot Settings -> Group Privacy -> Turn off
```

### 2. Запустите бота
```bash
cd H:\Code\anti-inline\anti-inline-bot
python src/main.py
```

### 3. Добавьте бота в группу
Добавьте бота в тестовую группу и дайте ему права администратора.

### 4. Протестируйте команды

#### Проверка режимов:
```
/mode              # Показать текущий режим
/mode all          # Блокировать все инлайн-боты
/mode blacklist    # Блокировать только из чёрного списка
/mode whitelist    # Блокировать все, кроме белого списка
```

#### Проверка чёрного списка:
```
/blacklist_list              # Показать список
/blacklist_add gif           # Добавить бота @gif
/blacklist_list              # Проверить, что добавлен
/blacklist_remove gif        # Удалить бота @gif
```

#### Проверка белого списка:
```
/whitelist_list              # Показать список
/whitelist_add gif           # Добавить бота @gif
/whitelist_list              # Проверить, что добавлен
/whitelist_remove gif        # Удалить бота @gif
```

#### Другие команды:
```
/toggle    # Включить/выключить удаление сообщений
/q         # Включить/выключить тихий режим (без предупреждений)
```

## Что смотреть в логах

При выполнении команды `/mode all` вы должны увидеть в логах:
```
INFO ... Received /mode command from user 123456789
INFO ... Checking admin rights for user 123456789 in chat -100123456789
INFO ... Member object type: <class 'aiogram.types.chat_member.ChatMember'>, status: creator
INFO ... User is admin (status: creator)
INFO ... Mode command args: 'all'
```

Если команда не работает, логи покажут, на каком этапе возникла проблема.

## Возможные проблемы

### Бот не отвечает на команды
1. **Privacy Mode включен** - бот не получает сообщения в группах
2. **Бот не администратор** - команды удаляются без ответа
3. **Redis недоступен** - должен автоматически использоваться InMemoryRedis (проверьте логи)

### Бот отвечает "Ошибка, вы не можете изменить эту настройку в личном чате"
Команды `/mode`, `/toggle`, `/q`, `/blacklist_*`, `/whitelist_*` работают только в группах.

### Статус пользователя не определяется
В логах будет видно: `Member object type: ... status: NO STATUS`. Это означает проблему с API Telegram или версией aiogram.

## Redis

Бот автоматически определяет доступность Redis:
- Если Redis доступен - использует его
- Если Redis недоступен - использует InMemoryRedis (данные хранятся в памяти)

Для отключения Redis установите переменную окружения:
```bash
export DISABLE_REDIS=1
```

Или в .env файле:
```
DISABLE_REDIS=1
```

